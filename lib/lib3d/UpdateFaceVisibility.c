#include <3d.h>

static u_short InvSqrt[];

void UpdateFaceVisibility(Object3D *object) {
  short cx = object->camera.x;
  short cy = object->camera.y;
  short cz = object->camera.z;
  void *sqrt = InvSqrt;

  void *_objdat = object->objdat;
  short *group = object->faceGroups;
  short f;

  do {
    while ((f = *group++)) {
      short *fn = FACE(f)->normal;
      short px, py, pz;
      int v;

      {
        short i = FACE(f)->indices[0].vertex;
        short *p = (short *)POINT(i);
        px = cx - *p++;
        py = cy - *p++;
        pz = cz - *p++;
      }

      {
        int x = *fn++ * px;
        int y = *fn++ * py;
        int z = *fn++ * pz;
        v = x + y + z;
      }

      if (v >= 0) {
        /* normalize dot product */
#if 0
        int s = px * px + py * py + pz * pz;
        s = swap16(s); /* s >>= 16, ignore upper word */
#else
        short s;
        asm("mulsw %0,%0\n"
            "mulsw %1,%1\n"
            "mulsw %2,%2\n"
            "addl  %1,%0\n"
            "addl  %2,%0\n"
            "swap  %0\n"
            : "+d"(px), "+d"(py), "+d"(pz));
        s = px;
        /* (short)s is in range 1-511 */
#endif
        v = swap16(v); /* v >>= 16, ignore upper word */
        /* (short)v is in range 0-255 */
        {
          short res;
          asm("add.w %1,%1\n"
              "muluw (%3,%1.w),%0\n" // v * InvSqrt[s]
              "swap %0"
              : "=d"(res), "+d"(s)
              : "0"(v), "a"(sqrt));
          *(char *)fn = res;
        }
      } else {
        *(char *)fn = -1;
      }
    }
  } while (*group);
}

#if 0
from contextlib import redirect_stdout
with redirect_stdout(open('invsqrt.txt','w')):
  for x in range(1, 512):
    v = round(65535/math.sqrt(x))
    print(f'{v},')
#endif

static u_short InvSqrt[512] = {
  0,     65535, 46340, 37837, 32768, 29308, 26755, 24770, 23170, 21845, 20724,
  19760, 18918, 18176, 17515, 16921, 16384, 15895, 15447, 15035, 14654, 14301,
  13972, 13665, 13377, 13107, 12852, 12612, 12385, 12170, 11965, 11770, 11585,
  11408, 11239, 11077, 10922, 10774, 10631, 10494, 10362, 10235, 10112, 9994,
  9880,  9769,  9663,  9559,  9459,  9362,  9268,  9177,  9088,  9002,  8918,
  8837,  8757,  8680,  8605,  8532,  8461,  8391,  8323,  8257,  8192,  8129,
  8067,  8006,  7947,  7889,  7833,  7778,  7723,  7670,  7618,  7567,  7517,
  7468,  7420,  7373,  7327,  7282,  7237,  7193,  7150,  7108,  7067,  7026,
  6986,  6947,  6908,  6870,  6832,  6796,  6759,  6724,  6689,  6654,  6620,
  6587,  6554,  6521,  6489,  6457,  6426,  6396,  6365,  6336,  6306,  6277,
  6249,  6220,  6192,  6165,  6138,  6111,  6085,  6059,  6033,  6008,  5982,
  5958,  5933,  5909,  5885,  5862,  5838,  5815,  5793,  5770,  5748,  5726,
  5704,  5683,  5661,  5640,  5620,  5599,  5579,  5559,  5539,  5519,  5500,
  5480,  5461,  5442,  5424,  5405,  5387,  5369,  5351,  5333,  5316,  5298,
  5281,  5264,  5247,  5230,  5214,  5197,  5181,  5165,  5149,  5133,  5117,
  5102,  5087,  5071,  5056,  5041,  5026,  5012,  4997,  4983,  4968,  4954,
  4940,  4926,  4912,  4898,  4885,  4871,  4858,  4844,  4831,  4818,  4805,
  4792,  4780,  4767,  4754,  4742,  4730,  4717,  4705,  4693,  4681,  4669,
  4657,  4646,  4634,  4622,  4611,  4600,  4588,  4577,  4566,  4555,  4544,
  4533,  4522,  4512,  4501,  4490,  4480,  4469,  4459,  4449,  4439,  4428,
  4418,  4408,  4398,  4389,  4379,  4369,  4359,  4350,  4340,  4331,  4321,
  4312,  4303,  4293,  4284,  4275,  4266,  4257,  4248,  4239,  4230,  4221,
  4213,  4204,  4195,  4187,  4178,  4170,  4161,  4153,  4145,  4137,  4128,
  4120,  4112,  4104,  4096,  4088,  4080,  4072,  4064,  4057,  4049,  4041,
  4033,  4026,  4018,  4011,  4003,  3996,  3988,  3981,  3974,  3966,  3959,
  3952,  3945,  3938,  3931,  3923,  3916,  3909,  3903,  3896,  3889,  3882,
  3875,  3868,  3862,  3855,  3848,  3842,  3835,  3829,  3822,  3816,  3809,
  3803,  3796,  3790,  3784,  3777,  3771,  3765,  3759,  3753,  3746,  3740,
  3734,  3728,  3722,  3716,  3710,  3704,  3698,  3692,  3687,  3681,  3675,
  3669,  3664,  3658,  3652,  3646,  3641,  3635,  3630,  3624,  3619,  3613,
  3608,  3602,  3597,  3591,  3586,  3581,  3575,  3570,  3565,  3559,  3554,
  3549,  3544,  3539,  3533,  3528,  3523,  3518,  3513,  3508,  3503,  3498,
  3493,  3488,  3483,  3478,  3473,  3468,  3464,  3459,  3454,  3449,  3444,
  3440,  3435,  3430,  3426,  3421,  3416,  3412,  3407,  3402,  3398,  3393,
  3389,  3384,  3380,  3375,  3371,  3366,  3362,  3357,  3353,  3349,  3344,
  3340,  3336,  3331,  3327,  3323,  3318,  3314,  3310,  3306,  3302,  3297,
  3293,  3289,  3285,  3281,  3277,  3273,  3269,  3265,  3260,  3256,  3252,
  3248,  3244,  3240,  3237,  3233,  3229,  3225,  3221,  3217,  3213,  3209,
  3205,  3202,  3198,  3194,  3190,  3186,  3183,  3179,  3175,  3171,  3168,
  3164,  3160,  3157,  3153,  3149,  3146,  3142,  3139,  3135,  3131,  3128,
  3124,  3121,  3117,  3114,  3110,  3107,  3103,  3100,  3096,  3093,  3089,
  3086,  3083,  3079,  3076,  3072,  3069,  3066,  3062,  3059,  3056,  3052,
  3049,  3046,  3042,  3039,  3036,  3033,  3029,  3026,  3023,  3020,  3016,
  3013,  3010,  3007,  3004,  3001,  2998,  2994,  2991,  2988,  2985,  2982,
  2979,  2976,  2973,  2970,  2967,  2964,  2961,  2958,  2955,  2952,  2949,
  2946,  2943,  2940,  2937,  2934,  2931,  2928,  2925,  2922,  2919,  2916,
  2913,  2911,  2908,  2905,  2902,  2899};
